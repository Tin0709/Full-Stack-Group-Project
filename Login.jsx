// RMIT University Vietnam
// Course: COSC2769 - Full Stack Development
// Semester: 2025B
// Assessment: Assignment 02
// Author: Tin (Nguyen Trung Tin)
// ID: s3988418

import React, { useEffect, useState } from "react";
import { Link, useNavigate, useLocation } from "react-router-dom";
import { useDispatch } from "react-redux";
import { setUser } from "../redux/slices/userSlice";
import { login } from "../services/authService";
import "./styles/Login.css";

export default function Login() {
  const navigate = useNavigate();
  const location = useLocation();
  const dispatch = useDispatch();

  const [username, setUsername] = useState("");
  const [password, setPassword] = useState("");
  const [submitting, setSubmitting] = useState(false);
  const [serverError, setServerError] = useState("");

  // Áp dụng delay cho từng path của SVG (thay cho <script> trong HTML)
  useEffect(() => {
    const paths = document.querySelectorAll("#art path");
    paths.forEach((p, i) => {
      p.style.animationDelay = `${0.08 * i}s`;
      if (!p.hasAttribute("pathLength")) p.setAttribute("pathLength", "1");
    });
  }, []);

  const handleSubmit = async (e) => {
    e.preventDefault();
    setServerError("");

    if (!username.trim() || !password.trim()) {
      setServerError("Please enter both username and password.");
      return;
    }

    setSubmitting(true);
    try {
      const user = await login({ username: username.trim(), password });
      dispatch(setUser(user));
      const redirect = location.state?.from || "/role";
      navigate(redirect, { replace: true });
    } catch (err) {
      const msg =
        err?.response?.data?.message || err?.message || "Login failed.";
      setServerError(msg);
    } finally {
      setSubmitting(false);
    }
  };

  return (
    <main className="login-page">
      <section className="login-card p-5">
        {/* ==== GENZ stroke logo (nhúng trực tiếp) ==== */}
        <div className="login-logo text-center mb-4">
          <svg
            id="art"
            viewBox="0 0 300 180"
            width="90%"
            height="90%"
            xmlns="http://www.w3.org/2000/svg"
          >
            <g>
              <path
                d="M207.584 3.15252C200.55 5.20652 198.541 9.30653 190.712 37.5915C185.643 55.9035 184.711 58.4455 184.169 55.4445C182.175 44.4035 179.604 25.3255 179.595 21.5065C179.583 16.5155 176.589 11.2235 172.802 9.49753C169.891 8.17153 162.404 9.88052 160.134 12.3895C157.167 15.6675 139.819 64.9955 135.496 82.4445C134.202 87.6695 133.052 92.0965 132.942 92.2825C132.832 92.4685 131.351 91.5935 129.653 90.3375L126.564 88.0535L114.324 90.3925C107.592 91.6795 100.08 93.3255 97.6306 94.0515C95.1806 94.7775 93.0146 95.2085 92.8156 95.0105C92.3406 94.5345 97.6576 77.1865 98.6066 76.1155C99.0106 75.6595 105.474 73.9865 112.969 72.3975C120.463 70.8085 127.462 69.0455 128.522 68.4775C130.79 67.2635 131.627 65.0175 131.845 59.5575C132.158 51.7165 127.682 50.0645 112.709 52.4935C109.203 53.0625 106.14 53.3345 105.903 53.0975C105.244 52.4385 111.724 34.4445 112.62 34.4445C113.052 34.4445 120.533 33.1125 129.245 31.4855C147.663 28.0445 149.584 26.8485 149.584 18.8225C149.584 10.3415 146.707 8.59852 135.667 10.3915C132.046 10.9795 122.109 12.3835 113.584 13.5115C97.6946 15.6135 93.5836 17.0355 93.5836 20.4305C93.5836 21.4965 92.7176 24.7485 91.6596 27.6565C84.9146 46.1955 68.5836 104.663 68.5836 110.272C68.5836 113.721 69.1766 115.192 71.5066 117.522C75.5106 121.526 77.9656 121.353 99.1886 115.564C109.031 112.88 119.086 110.35 121.532 109.943C124.312 109.48 126.984 108.199 128.655 106.528L131.33 103.853L132.525 107.159C133.922 111.021 138.457 113.766 141.981 112.882C146.337 111.788 148.314 108.208 152.439 93.9445C154.665 86.2445 158.274 74.8035 160.457 68.5195C164.083 58.0855 164.475 57.3915 164.976 60.5195C165.277 62.4035 166.693 71.8195 168.121 81.4445C171.247 102.519 171.863 104.66 175.727 107.912C181.968 113.163 190.013 109.784 192.978 100.665C196.857 88.7345 215.383 11.3805 214.866 9.27153C213.845 5.11053 210.501 2.30052 207.584 3.15252ZM244.138 8.35653C218.111 11.3795 219.42 10.7575 216.693 21.3965C215.55 25.8555 215.588 26.8025 216.998 28.9535C219.317 32.4925 222.118 32.8305 234.762 31.0955C240.955 30.2455 246.115 29.6425 246.228 29.7555C246.341 29.8685 242.751 34.9075 238.249 40.9525C199.911 92.4405 198.584 94.3855 198.584 99.0825C198.584 102.53 199.164 104.116 201.151 106.103C203.496 108.448 204.252 108.626 209.901 108.163C213.302 107.885 223.059 106.055 231.584 104.097C240.109 102.14 253.419 99.4495 261.161 98.1185C268.904 96.7885 276.159 95.2065 277.285 94.6045C279.354 93.4975 281.584 86.9605 281.584 82.0015C281.584 78.5315 278.264 75.4445 274.531 75.4445C272.852 75.4445 263.354 77.0455 253.424 79.0035C243.493 80.9605 235.14 82.3335 234.861 82.0545C234.581 81.7755 237.99 76.8355 242.435 71.0765C246.881 65.3185 257.508 51.3215 266.051 39.9725C279.621 21.9455 281.584 18.8675 281.584 15.6135C281.584 12.1375 279.586 7.90652 277.142 6.20952C275.482 5.05652 268.807 5.49153 244.138 8.35653ZM53.0836 7.84652C38.6256 12.4315 27.3526 23.8835 17.0606 44.4445C1.16957 76.1895 -1.69343 111.783 10.7366 123.078C18.1226 129.79 28.2776 130.868 37.9556 125.968C48.7766 120.489 62.9016 103.98 69.5916 88.9925C73.6666 79.8655 77.7076 67.7965 77.8016 64.4715C77.9506 59.2375 76.0826 58.1365 68.1136 58.7615C56.0496 59.7075 42.9016 62.1895 40.0476 64.0595C34.9336 67.4105 32.7466 77.4725 36.4126 80.7895C38.4726 82.6545 42.2066 82.9185 46.0186 81.4695C47.4296 80.9325 48.5836 80.7255 48.5836 81.0095C48.5836 84.2165 37.4896 98.8345 31.2486 103.851C27.5236 106.844 27.3726 106.877 25.9986 104.998C24.1056 102.409 24.2146 98.4015 26.4966 86.7295C29.6166 70.7735 35.3696 56.6505 44.1276 43.4445C52.6096 30.6565 60.7076 25.4295 59.2196 33.7055C57.2006 44.9355 57.2136 45.1655 60.0436 47.9945C62.3186 50.2705 63.3436 50.6055 66.6676 50.1605C72.9606 49.3155 77.9156 46.2495 79.2776 42.3575C80.9256 37.6435 80.8696 26.7125 79.1676 21.0585C75.4446 8.68552 65.8166 3.80952 53.0836 7.84652ZM197.148 57.4635C191.349 81.2525 186.095 101.33 185.472 102.08C183.645 104.281 179.654 103.758 178.678 101.191C177.525 98.1585 173.009 70.9245 171.092 55.4445C169.115 39.4825 168.949 38.7985 166.851 37.9935C164.444 37.0695 162.308 39.9685 160.142 47.0995C159.166 50.3145 155.979 60.3695 153.061 69.4445C150.143 78.5195 146.345 90.5875 144.62 96.2615C141.283 107.241 139.322 109.029 138.775 101.593C138.14 92.9535 148.656 58.6915 163.785 20.1105C165.19 16.5285 169.517 14.6325 171.16 16.8795C171.785 17.7335 172.588 21.4725 172.946 25.1885C174.183 38.0455 181.357 80.6175 182.476 81.7365C184.623 83.8835 186.245 80.1065 190.546 62.9445C198.321 31.9175 206.636 6.80453 207.388 12.0785C207.556 13.2515 202.948 33.6755 197.148 57.4635ZM274.916 13.8665C275.575 15.5845 269.767 23.8795 246.008 55.1515C222.057 86.6785 220.164 89.4245 221.474 90.7345C222.226 91.4865 228.046 90.7175 241.311 88.1165C262.967 83.8685 273.637 82.1635 274.315 82.8425C274.578 83.1045 274.371 84.5835 273.856 86.1285C272.963 88.8085 272.44 89.0125 262.502 90.5605C250.663 92.4055 218.587 99.1125 214.899 100.516C211.262 101.898 205.877 101.652 205.272 100.076C204.6 98.3225 206.396 95.4185 217.234 80.7365C222.101 74.1425 232.159 60.4875 239.584 50.3915C247.009 40.2955 254.777 30.0685 256.847 27.6645C258.916 25.2605 260.323 22.8315 259.974 22.2655C259.298 21.1725 254.516 21.5105 234.699 24.0495C228.438 24.8515 223.105 25.2995 222.85 25.0435C222.594 24.7875 222.914 22.9735 223.562 21.0115C224.511 18.1355 225.257 17.4325 227.412 17.3825C228.881 17.3495 238.634 16.2775 249.084 15.0025C272.51 12.1425 274.225 12.0675 274.916 13.8665ZM69.2286 16.8175C72.9436 21.1365 74.8216 32.2325 72.9906 39.0505C72.4416 41.0955 66.0206 44.0275 65.2156 42.6005C65.0116 42.2395 65.3056 39.2265 65.8696 35.9055C67.0586 28.8975 65.7736 24.9645 61.5146 22.5775C57.4746 20.3135 53.7316 21.9215 46.9686 28.8245C33.5596 42.5125 21.9076 68.5005 18.6376 92.0085C16.9956 103.817 18.8186 110.443 24.2796 112.52C28.3546 114.069 32.7216 112.004 39.4316 105.357C47.7516 97.1135 59.5836 78.7245 59.5836 74.0365C59.5836 71.5495 58.2396 71.4805 50.1536 73.5525C45.8646 74.6505 42.1406 75.3355 41.8786 75.0725C40.7346 73.9285 42.8796 70.5715 45.3666 69.6095C48.8796 68.2525 69.5956 65.1235 70.3136 65.8415C71.2416 66.7695 65.6456 81.4905 61.0586 90.1875C53.2226 105.046 43.1896 115.941 33.0836 120.569C24.6646 124.425 16.3116 121.584 12.3336 113.511C10.3496 109.485 10.0916 107.467 10.1476 96.4445C10.2016 86.0805 10.6786 82.2355 12.9396 73.9445C22.7216 38.0675 43.5926 12.5085 62.0246 13.8325C65.8606 14.1085 67.4726 14.7765 69.2286 16.8175ZM142.584 18.8855C142.584 21.1405 141.216 21.5975 124.297 25.0025C115.553 26.7615 107.831 28.8185 107.137 29.5735C105.604 31.2405 96.5836 56.8455 96.5836 59.5295C96.5836 61.9215 99.1696 62.0015 109.922 59.9445C120.898 57.8445 124.584 57.9445 124.584 60.3445C124.584 61.9025 123.19 62.5465 116.834 63.9265C101.636 67.2265 94.2676 69.3375 93.4236 70.6315C92.6596 71.8015 91.1106 76.7315 86.0666 94.0325C84.3996 99.7505 84.1806 103.078 85.4196 103.844C85.8796 104.128 89.1426 103.473 92.6696 102.387C97.6926 100.841 122.175 95.4445 124.165 95.4445C125.184 95.4445 124.457 100.306 123.293 101.271C122.583 101.861 119.771 102.833 117.043 103.432C114.316 104.031 104.835 106.529 95.9746 108.983C77.7536 114.03 75.9716 114.243 75.0946 111.478C74.1526 108.512 87.6386 59.8275 96.8486 32.9445L100.275 22.9445L106.679 21.6575C114.756 20.0345 132.743 17.7045 138.334 17.5565C141.42 17.4755 142.584 17.8395 142.584 18.8855ZM165.084 120.539C145.428 121.373 129.416 123.438 106.584 128.086C91.1016 131.238 70.6486 136.569 63.2576 139.379C59.4336 140.833 57.6056 144.406 56.9176 151.768C55.7776 163.984 60.7756 166.826 74.2666 161.633C108.14 148.592 154.105 139.816 198.831 137.85C210.427 137.34 214.884 136.788 215.739 135.759C217.701 133.394 215.459 132.485 206.038 131.826C174.074 129.593 109.933 140.63 72.2146 154.855C68.4366 156.279 64.9976 157.445 64.5716 157.445C63.0746 157.445 62.7476 154.638 63.7726 150.598L64.8086 146.517L75.9466 143.037C115.704 130.617 172.215 124.183 213.084 127.425C244.634 129.928 242.584 129.916 242.584 127.593C242.584 125.271 240.526 124.53 226.869 121.94C217.437 120.15 189.295 119.512 165.084 120.539Z"
                fill="none"
                stroke="#111"
                strokeWidth="5"
                strokeLinejoin="round"
                strokeLinecap="round"
              />
            </g>
          </svg>
        </div>

        {/* ==== Form Login ==== */}
        <form onSubmit={handleSubmit} noValidate>
          <div className="mb-3 login-field">
            <label className="form-label">Username</label>
            <input
              className="form-control form-control-lg"
              placeholder="Enter your username"
              value={username}
              onChange={(e) => setUsername(e.target.value)}
              autoComplete="username"
            />
          </div>

          <div className="mb-3 login-field">
            <label className="form-label">Password</label>
            <input
              type="password"
              className="form-control form-control-lg"
              placeholder="Enter your password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              autoComplete="current-password"
            />
          </div>

          {serverError && (
            <div className="alert alert-danger py-2 mb-3" role="alert">
              {serverError}
            </div>
          )}

          <button
            type="submit"
            disabled={submitting}
            className="btn btn-dark btn-lg w-100"
          >
            {submitting ? "Logging in..." : "Login"}
          </button>
<div className="social-login">
  <div className="icons">
    <button className="icon-btn">{/* Google */} <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 48 48">
  <circle cx="24" cy="24" r="22" fill="white" stroke="black" strokeWidth="3"/>
  <path d="M24 19v6.2h8.6c-.3 2-1 3.5-2.2 4.6-1.5 1.4-3.6 2.2-6.4 2.2-3.2 0-5.9-1.1-7.9-3.2-2.1-2.1-3.1-4.8-3.1-7.9s1-5.8 3.1-7.9c2-2.1 4.7-3.2 7.9-3.2 2.6 0 4.8.8 6.6 2.3l4-4C32 6.7 28.3 5 24 5c-5.2 0-9.6 1.8-13.1 5.3C7.4 14 5.6 18.4 5.6 24s1.8 10 5.3 13.5c3.5 3.5 7.9 5.3 13.1 5.3 5.1 0 9.4-1.7 12.5-4.9 3.3-3.3 4.9-7.8 4.9-13.3 0-1-.1-2-.3-3H24z"
        fill="none" stroke="black" strokeWidth="2.5"/>
</svg>
</button>
    <button className="icon-btn">{/* Facebook */} <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 48 48">
  <circle cx="24" cy="24" r="22" fill="white" stroke="black" strokeWidth="3"/>
  <path d="M28 14h-3c-2 0-3 1-3 3v4h-3v5h3v12h6V26h4l1-5h-5v-3c0-1 .5-1.5 1.5-1.5H33v-5h-5z"
        fill="none" stroke="black" strokeWidth="2.5"/>
</svg>
</button>
    <button className="icon-btn">{/* GitHub */} <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 48 48">
  <circle cx="24" cy="24" r="22" fill="white" stroke="black" strokeWidth="3"/>
  <path d="M24 9c-8 0-14.5 6.5-14.5 14.5 0 6.4 4.2 11.8 10 13.7v-3c-2.7.6-3.2-1.3-3.2-1.3-.5-1.3-1.2-1.7-1.2-1.7-1-.7.1-.7.1-.7 1.2.1 1.8 1.3 1.8 1.3 1 1.8 2.6 1.3 3.2 1 .1-.7.4-1.3.7-1.6-3.3-.4-6.7-1.7-6.7-7.5 0-1.7.6-3.1 1.5-4.2-.2-.4-.7-1.9.1-4 0 0 1.2-.4 4.2 1.5a14.3 14.3 0 0 1 7.6 0c3-1.9 4.2-1.5 4.2-1.5.8 2.1.3 3.6.1 4 1 1 1.5 2.5 1.5 4.2 0 5.8-3.4 7.1-6.7 7.5.5.4.9 1.2.9 2.4v3.6c5.8-1.9 10-7.3 10-13.7C38.5 15.5 32 9 24 9z"
        fill="none" stroke="black" strokeWidth="2.5"/>
</svg>
</button>
  </div>
</div>
          <p className="text-center small mt-3 mb-0">
            Don’t have an account? <Link to="/register">Register Now</Link>
          </p>
          <p className="text-center small mt-2 mb-0">
            <Link to="/help" className="link-underline">
              Forgot Password?
            </Link>
          </p>
        </form>
      </section>
    </main>
  );
}
